<div class="card m-2 mx-auto" style="width: 60%">
  <div class="card-header">
    <h3>TODO List</h3>
  </div>
  <div class="card-body">
    <form action="$(Genie.Router.link_to(:create_task))" method="POST">
      <div class="input-group mb-3">
        <input class="form-control" type="date" name="task_deadline" value="$(@vars(:today))"/>
        <input id="todo-content" class="form-control" type="text" name="task_content" placeholder="Write down your TODO" style="width: 50%" />
        <div class="input-group-append">
          <input type="submit" value="Create" class="btn btn-sm btn-primary"/>
        </div>
      </div>
    </form>
    <input type="checkbox" class="checkbox" id="done-display-checkbox" checked>
    <% """
      <label for="done-display-checkbox"><small>show done</small></label>
       """ %>

    <table class="table table-striped table-bordered table-sm">
      <thead>
        <tr>
          <th class="th-sm" style="width: 7%">done</th>
          <th class="th-sm" style="width: 16%">deadline</th>
          <th class="th-sm" style="">content</th>
          <th class="th-sm" style="width: 9%">action</th>
        </tr>
      </thead>
      <tbody>
        <%
          if length(@vars(:tasks)) == 0
            "タスクがありません。"
          else
            @foreach(@vars(:tasks)) do task
              """
              <tr id="tr_$(get(task.id))" data-id="$(get(task.id))">
                <td>
                  <input type="checkbox" id="$(get(task.id))" data-id="$(get(task.id))"
                         class="checkbox done-checkbox" $(task.done ? "checked" : "") />
                </td>
                <td>
                  <span id="deadline_$(get(task.id))" class=$(task.done ? "done" : task.deadline <= @vars(:today) ? "deadline" : "doing")>
                        $(task.deadline)
                  </span>
                </td>
                <td>
                  <span id="content_$(get(task.id))" class=$(task.done ? "done" : task.deadline <= @vars(:today) ? "deadline" : "doing")>
                        $(task.content)
                  </span>
                </td>
                <td>
                  <button data-id="$(get(task.id))" class="btn btn-block btn-sm btn-danger delete-button">Delete</button>
                </td>
              </tr>
              """
            end
          end
        %>
      </tbody>
    </table>
  </div>
</div>

<style>
  .done { text-decoration: line-through; }
  .deadline { color: red; font-weight: bold; }
</style>

<script>
  \$(".done-checkbox").on("change", function() {
      return ajaxUpdateStatus(\$(this).data("id"), \$(this).prop("checked"));
  });

  \$(".delete-button").on("click", function() {
      if (confirm("Are you sure?")) {
          return ajaxDestroy(\$(this).data("id"));
      }
  });

  function ajaxUpdateStatus(id, done) {
    \$.ajax({
      url: "$(Genie.Router.link_to(:update_task))",
      data: { task_id: id, task_done: done },
      type: "POST",
      dataType: 'json'
    }).then(
      data => {
        if (done) {
            \$("#content_" + id).css("text-decoration", "line-through");
            \$("#deadline_" + id).css("text-decoration", "line-through");
        } else {
            \$("#content_" + id).css("text-decoration", "none");
            \$("#deadline_" + id).css("text-decoration", "none");
        }
      },
      error => alert("更新に失敗しました。")
    );
  }

  function ajaxDestroy(id) {
    \$.ajax({
      url: "$(Genie.Router.link_to(:destroy_task))",
      data: { task_id: id },
      type: "POST",
      dataType: 'json'
    }).then(
      data => {
          \$("#tr_" + id).fadeOut().queue(function() {
              this.remove();
          });
      },
      error => alert("削除に失敗しました。")
    );
  }

  \$("#done-display-checkbox").on("change", function() {
    if(\$(this).prop("checked")) {
      \$("tr:has(.done-checkbox:checked)").show();
    } else {
      \$("tr:has(.done-checkbox:checked)").hide();
    }
  });

  \$("#todo-content").focus();
</script>
